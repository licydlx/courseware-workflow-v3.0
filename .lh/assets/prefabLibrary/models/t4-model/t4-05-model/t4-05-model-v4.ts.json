{
    "sourceFile": "assets/prefabLibrary/models/t4-model/t4-05-model/t4-05-model-v4.ts",
    "activeCommit": 0,
    "commits": [
        {
            "activePatchIndex": 0,
            "patches": [
                {
                    "date": 1625136082123,
                    "content": "Index: \n===================================================================\n--- \n+++ \n"
                }
            ],
            "date": 1625136082123,
            "name": "Commit-0",
            "content": "\r\n/*\r\n * @Descripttion: \r\n * @version: \r\n * @Author: ruzhuan\r\n * @Date: 2021-06-08 18:00:00\r\n * @LastEditors: ruzhuan\r\n * @LastEditTime: 2021-06-08 18:00:00\r\n */\r\nconst { loadBundle, loadPrefab, loadResource } = window['GlobalData'].sample;\r\nconst { ccclass, property } = cc._decorator;\r\n\r\n@ccclass\r\nexport default class t4_05_model_v4 extends cc.Component {\r\n    private _worldRoot: cc.Node;\r\n\r\n    private _view: fgui.GComponent;\r\n\r\n    private _c1: fgui.Controller;\r\n\r\n    private _title: fgui.GButton;\r\n\r\n    private _titleTrigger: fgui.GLoader;\r\n\r\n    private _submitBtn: fgui.GButton;\r\n\r\n    private _resetBtn: fgui.GButton;\r\n\r\n    private _package: any;\r\n\r\n    private _touchesPos: any = [];\r\n\r\n    private _moveCurPos: cc.Vec2;\r\n\r\n    private graphics: cc.Graphics = null;\r\n\r\n    private _dragging = false;\r\n\r\n    private _scheduleTime = 0.03;\r\n\r\n    private submitType: any = cc.Enum({\r\n\r\n        No: 0,\r\n        GuideShow: 1,\r\n        WrongFeed: 2,\r\n        RightFeed: 3\r\n    });\r\n\r\n    // 远程动态组件\r\n    private feedback: any;\r\n\r\n    private _state = {};\r\n\r\n    get state(): any {\r\n        return this._state;\r\n    }\r\n\r\n    set state(v: any) {\r\n        this.updateUi(this._state, v);\r\n        this._state = v;\r\n        this.mergeState();\r\n    }\r\n\r\n    async onLoad() {\r\n\r\n        this._worldRoot = cc.find(\"Canvas\").parent;\r\n\r\n        this._view.y = (fgui.GRoot.inst.height - this._view.height) / 2;\r\n        this._view.x = (fgui.GRoot.inst.width - this._view.width) / 2;\r\n\r\n        fgui.GRoot.inst.addChild(this._view);\r\n\r\n        this._c1 = this._view.getController(\"c1\");\r\n\r\n        // 臨時\r\n        // bug 初始设置不播放不生效\r\n        if (this._c1) {\r\n            this._c1.selectedIndex = 1;\r\n            this._c1.selectedIndex = 0;\r\n        }\r\n\r\n        this._titleTrigger = this._view.getChild(\"titleTrigger\").asLoader;\r\n        if (this._titleTrigger) this._titleTrigger.on(fgui.Event.CLICK, this._clickTitle, this);\r\n\r\n        this._title = this._view.getChild(\"title\").asButton;\r\n\r\n        this._submitBtn = this._view.getChild(\"submit\").asButton;\r\n        if (this._submitBtn) this._submitBtn.on(fgui.Event.CLICK, this._clickSubmit, this);\r\n\r\n        this._resetBtn = this._view.getChild(\"restart\").asButton;\r\n        this._resetBtn.on(fgui.Event.CLICK, this._clickReset, this);\r\n\r\n        this._view.on(cc.Node.EventType.TOUCH_START, this._onDrawStart, this);\r\n        this._view.on(cc.Node.EventType.TOUCH_MOVE, this._onDrawMove, this);\r\n        this._view.on(cc.Node.EventType.TOUCH_END, this._onDrawEnd, this);\r\n\r\n        let huiNode = new cc.Node('huiNode');\r\n        huiNode.parent = this._worldRoot;\r\n\r\n        this.graphics = huiNode.addComponent(cc.Graphics);\r\n        this.graphics.lineWidth = 20;\r\n        this.graphics.lineJoin = cc.Graphics.LineJoin.ROUND;\r\n        this.graphics.strokeColor = cc.color(255, 0, 0);\r\n        this.graphics.fillColor = cc.color(255, 0, 0);\r\n\r\n        // 初始化state\r\n        this._state = {\r\n            title: false,\r\n            submit: this.submitType.No,\r\n            touch: \"end\",\r\n            reset: false,\r\n            touchesPos: [],\r\n        }\r\n    }\r\n\r\n    async init(data: any) {\r\n        // 临时 model component json 配置加载\r\n        let { pathConfig, model, components } = data;\r\n        let Package = pathConfig.packageName;\r\n        let GComponent = model.uiPath;\r\n        let { boxSoundUrl, guidIndex } = model.config;\r\n        this._package = Package;\r\n\r\n        this._view = fgui.UIPackage.createObject(Package, GComponent).asCom;\r\n\r\n        if (components) {\r\n            for (const key in components) {\r\n                let componentPath: any = `${pathConfig.remoteUrl}${pathConfig.componentBundlePath}${components[key].bundleName}`;\r\n                let componentBundle: any = await loadBundle(componentPath);\r\n                let componentPrefab: any = await loadPrefab(componentBundle, components[key].prefabName);\r\n                this[key] = componentPrefab;\r\n            }\r\n        }\r\n    }\r\n\r\n    _onDrawStart(event) {\r\n        console.log('===== start 111 ====' + event.touch.getLocation());\r\n\r\n        let state: any = globalThis._.cloneDeep(this._state);\r\n        state.touch = 'start';\r\n        let tempPos = new cc.Vec2(event.touch.getLocation().x, event.touch.getLocation().y);\r\n        state.touchesPos.push(tempPos);\r\n        this.updateState(state);\r\n    }\r\n\r\n    _onDrawMove(event) {\r\n\r\n        this._dragging = true;\r\n        this._moveCurPos = new cc.Vec2(event.touch.getLocation().x, event.touch.getLocation().y);\r\n    }\r\n\r\n    _onDrawEnd(event) {\r\n\r\n        this._dragging = false;\r\n\r\n        let state: any = globalThis._.cloneDeep(this._state);\r\n        state.touch = 'end';\r\n        this.updateState(state);\r\n    }\r\n\r\n\r\n    // 排序方法\r\n    comparePos() {\r\n        return function (a, b) {\r\n            var value1 = a.x;\r\n            var value2 = b.x;\r\n            return value1 - value2;\r\n        }\r\n    }\r\n\r\n    private _clickReset(evt: any) {\r\n        let state: any = globalThis._.cloneDeep(this._state);\r\n        state.reset = true;\r\n        this.updateState(state);\r\n\r\n    }\r\n\r\n    private _clickSubmit(evt: any) {\r\n        let state: any = globalThis._.cloneDeep(this._state);\r\n        this.updateState(state);\r\n    }\r\n\r\n    private _clickTitle(evt: any) {\r\n        let state: any = globalThis._.cloneDeep(this._state);\r\n        state.title = true;\r\n        this.updateState(state);\r\n    }\r\n\r\n    // 临时\r\n    // 拖拽定时器\r\n    dragSchedule() {\r\n        if (this._dragging) {\r\n\r\n            console.log('==== 3333333 拖拽定时器 ======');\r\n            let state: any = globalThis._.cloneDeep(this._state);\r\n            state.touchesPos.push(this._moveCurPos);\r\n            state.touch = \"move\";\r\n            this.updateState(state);\r\n        }\r\n    }\r\n\r\n    // 获取状态\r\n    getState(data: any) {\r\n        this.updateState(data);\r\n    }\r\n\r\n    // 更新状态层\r\n    updateState(curState: any) {\r\n        if (globalThis._.isEqual(this._state, curState)) return;\r\n        this.state = curState;\r\n    }\r\n\r\n    // 更新ui层\r\n    updateUi(oldState: any, state: any) {\r\n\r\n        if (state.touch == \"start\") {\r\n\r\n            this._touchesPos = state.touchesPos;\r\n            this.graphics.clear();\r\n            this._touchesPos.length = 0;\r\n\r\n        } else if (state.touch == \"move\") {\r\n\r\n            this._touchesPos = state.touchesPos;\r\n            const MIN_POINT_DISTANCE = 4;\r\n\r\n            let worldPos = this.node.convertToWorldSpaceAR(cc.v2(0, 0));\r\n            this.graphics.moveTo(this._touchesPos[0].x - worldPos.x, this._touchesPos[0].y - worldPos.y);\r\n            let lastIndex = 0;\r\n            for (let i = 1, l = this._touchesPos.length; i < l; i++) {\r\n                if (this._touchesPos[i].sub(this._touchesPos[lastIndex]).mag() < MIN_POINT_DISTANCE) {\r\n                    continue;\r\n                }\r\n                lastIndex = i;\r\n                this.graphics.lineTo(this._touchesPos[i].x - worldPos.x, this._touchesPos[i].y - worldPos.y);\r\n            }\r\n            this.graphics.stroke();\r\n\r\n        } else if (state.touch == \"end\") {\r\n\r\n            this.graphics.clear();\r\n\r\n            if (this._touchesPos.length > 0) {\r\n\r\n                let angle = this.angle(this._touchesPos[0], this._touchesPos[this._touchesPos.length - 1]);\r\n\r\n                console.log('===== angle 999999 === ' + angle);\r\n\r\n                let zhiLine = fgui.UIPackage.createObjectFromURL('ui://mgpb39d5xdox2a');\r\n                this._view.addChild(zhiLine);\r\n                zhiLine.width = this._touchesPos[this._touchesPos.length - 1].sub(this._touchesPos[0]).mag();\r\n                zhiLine.x = this._touchesPos[0].x;\r\n                zhiLine.y = this._view.height - this._touchesPos[0].y;\r\n                zhiLine.rotation = -angle;\r\n\r\n                zhiLine.sortingOrder = 0;\r\n\r\n                this._touchesPos.sort(this.comparePos());\r\n\r\n\r\n            }\r\n\r\n        }\r\n\r\n\r\n        if (!globalThis._.isEqual(oldState.submit, state.submit)) {\r\n\r\n            if (state.submit === this.submitType.RightFeed) {\r\n\r\n                this.answerFeedback(true);\r\n\r\n            } else if (state.submit === this.submitType.WrongFeed) {\r\n\r\n                this.answerFeedback(false);\r\n\r\n            } else if (state.submit === this.submitType.GuideShow) {\r\n\r\n                let keyBtn = this._view.getChild('input1').asButton;\r\n                this.handTips2(keyBtn);\r\n            }\r\n        }\r\n\r\n\r\n        if (!globalThis._.isEqual(oldState.title, state.title)) {\r\n            this.playTitle(state.title);\r\n        }\r\n    }\r\n\r\n    angle(start, end) {\r\n        var diff_x = end.x - start.x,\r\n            diff_y = end.y - start.y;\r\n        //返回角度,不是弧度\r\n        return 360 * Math.atan(diff_y / diff_x) / (2 * Math.PI);\r\n    }\r\n\r\n\r\n    async playTitle(bool: boolean) {\r\n        this._c1.selectedIndex = bool ? 1 : 0;\r\n        if (bool) {\r\n            cc.audioEngine.stopAll();\r\n            this.forbidHandle();\r\n            let item = fgui.UIPackage.getItemByURL(this._title[\"_sound\"]);\r\n            let audio: cc.AudioClip = await loadResource(item.file, cc.AudioClip);\r\n            let audioId = cc.audioEngine.play(audio, false, 1);\r\n            cc.audioEngine.setFinishCallback(audioId, () => {\r\n                let state: any = globalThis._.cloneDeep(this._state);\r\n                state.title = false;\r\n                this.updateState(state);\r\n            });\r\n        } else {\r\n            this.disableForbidHandle();\r\n        }\r\n    }\r\n\r\n    answerFeedback(bool: boolean) {\r\n        if (!this.feedback) return;\r\n        let feedback: any = cc.instantiate(this.feedback);\r\n        feedback.x = 960;\r\n        feedback.y = 540;\r\n        let feedbackJs: any = feedback.getComponent(cc.Component);\r\n        feedbackJs.init(bool);\r\n        feedback.parent = cc.find(\"Canvas\").parent;\r\n\r\n        setTimeout(() => {\r\n            feedback.destroy();\r\n            let state: any = globalThis._.cloneDeep(this._state);\r\n            state.submit = this.submitType.No;\r\n            this.updateState(state);\r\n        }, 2000);\r\n    }\r\n\r\n\r\n    /**\r\n     * 点击指引\r\n     * @param obj 点击对象\r\n     */\r\n    handTips2(obj: fgui.GObject) {\r\n        let hand = fgui.UIPackage.createObject(this._package, 'hand');\r\n        this._view.addChild(hand);\r\n        let tempX = obj.x;\r\n        let tempY = obj.y;\r\n\r\n        hand.x = tempX;\r\n        hand.y = tempY;\r\n\r\n        cc.tween(hand).to(0.3, {\r\n            x: tempX - 30,\r\n            y: tempY - 30\r\n        }).to(0.3, {\r\n            x: tempX,\r\n            y: tempY\r\n        }).to(0.3, {\r\n            x: tempX - 30,\r\n            y: tempY - 30\r\n        }).to(0.3, {\r\n            x: tempX,\r\n            y: tempY\r\n        }).call(() => {\r\n            this._view.removeChild(hand);\r\n            hand = null;\r\n            let state: any = globalThis._.cloneDeep(this._state);\r\n            state.submit = this.submitType.No;\r\n            this.updateState(state)\r\n        }).start();\r\n    }\r\n\r\n    // 运行时 禁止操作\r\n    forbidHandle() {\r\n        console.log('===  运行时 禁止操作 =====');\r\n        let handleMask = this._worldRoot.getChildByName('handleMask');\r\n        if (!handleMask) {\r\n            let handleMask = new cc.Node('handleMask');\r\n            handleMask.addComponent(cc.BlockInputEvents);\r\n            handleMask.parent = this._worldRoot;\r\n            handleMask.width = 1920;\r\n            handleMask.height = 1080;\r\n            handleMask.x = 960;\r\n            handleMask.y = 540;\r\n        }\r\n    }\r\n\r\n    // 消除禁止\r\n    disableForbidHandle() {\r\n        let handleMask = this._worldRoot.getChildByName('handleMask');\r\n        if (handleMask) handleMask.destroy();\r\n    }\r\n\r\n    // 注册状态，及获取状态的方法\r\n    registerState() {\r\n        if (window['GlobalData'].sample.registerState) window['GlobalData'].sample.registerState.call(this);\r\n    }\r\n\r\n    // 解除状态，及获取状态的方法\r\n    relieveState() {\r\n        if (window['GlobalData'].sample.relieveState) window['GlobalData'].sample.relieveState.call(this);\r\n    }\r\n\r\n    // 本组件状态合并到全局\r\n    mergeState() {\r\n        if (window['GlobalData'].sample.mergeState) window['GlobalData'].sample.mergeState.call(this);\r\n    }\r\n\r\n    onEnable() {\r\n        this.registerState();\r\n        this.schedule(this.dragSchedule, this._scheduleTime);\r\n    }\r\n\r\n    onDisable() {\r\n        this.relieveState();\r\n        cc.audioEngine.stopAll();\r\n    }\r\n}\r\n"
        }
    ]
}