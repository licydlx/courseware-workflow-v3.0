{"version":3,"sources":["assets\\prefabLibrary\\controller\\controller-model02\\scripts\\controller-model02-getMessage.ts"],"names":[],"mappings":"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","file":"","sourceRoot":"/","sourcesContent":["/*\r\n * @Descripttion: \r\n * @version: \r\n * @Author: ydlx\r\n * @Date: 2021-02-07 11:39:43\r\n * @LastEditors: ydlx\r\n * @LastEditTime: 2021-03-16 16:37:40\r\n */\r\n\r\nexport async function getMessage(data: any) {\r\n    console.log('getMessage')\r\n    let message = globalThis._.cloneDeep(data);\r\n    console.log(message)\r\n    \r\n    switch (data.method) {\r\n        case \"onJumpPage\": {\r\n            this.onJumpConfig(data.toPage);\r\n            break;\r\n        }\r\n\r\n        case 'onFileMessage': {\r\n            if (data.isRestore) {\r\n                return;\r\n            }\r\n\r\n            if (data.handleData.action == \"EVENT_UPDATE_STATE\") {\r\n                if (!window['GlobalData'].stateProxy) return;\r\n                let { name, userid, role, signalingModel, monitored } = window['GlobalData'].courseData;\r\n                let user = data.handleData.user;\r\n                let curState = data.handleData.handleData;\r\n                let prevState = globalThis._.cloneDeep(window['GlobalData'].stateProxy[\"state\"]);\r\n\r\n                if (data.handleData.toUser) {\r\n                    let toUser = data.handleData.toUser;\r\n                    \r\n                    // 兼容\r\n                    // 安卓ipad 部分账户 无法获取userid 用name替代\r\n                    if (toUser.id == userid || encodeURIComponent(toUser.nickname) == userid) {\r\n                        Object.keys(prevState).forEach((v) => {\r\n                            if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                // state 流转 临时\r\n                                window['GlobalData'].stateProxy[v] = \"\";\r\n                                window['GlobalData'].pubSub.emit(curState[v], v);\r\n                            }\r\n                        });\r\n                    }\r\n                } else {\r\n                    // 老师同步学生\r\n                    if (role == 0) {\r\n                        // 演示模式 相互通信\r\n                        if (signalingModel == 1) {\r\n                            Object.keys(prevState).forEach((v) => {\r\n                                if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                    // state 流转 临时\r\n                                    window['GlobalData'].stateProxy[v] = \"\";\r\n                                    window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        // 答题模式 \r\n                        // 1.老师保存学生答案 2.老师保存并渲染学生答案\r\n                        if (signalingModel == 2) {\r\n                            if (user.role == 2) {\r\n                                let panleState: any = globalThis._.cloneDeep(window['GlobalData'].stateProxy[\"formal-panle-model02\"]);\r\n                                panleState.snapshoot[user.userid] = curState;\r\n                                window['GlobalData'].stateProxy[\"formal-panle-model02\"] = \"\";\r\n                                window['GlobalData'].pubSub.emit(panleState, \"formal-panle-model02\");\r\n\r\n                                if (monitored && (user.userid == monitored || user.name == monitored)) {\r\n                                    Object.keys(prevState).forEach((v) => {\r\n                                        if (!(globalThis._.isEqual(prevState[v], curState[v])) && v != \"formal-panle-model02\") {\r\n                                            // state 流转 临时\r\n                                            window['GlobalData'].stateProxy[v] = \"\";\r\n                                            window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                        }\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // 学生 同步老师\r\n                    if (role == 2) {\r\n                        // 演示模式 相互通信\r\n                        if (signalingModel == 1) {\r\n                            Object.keys(prevState).forEach((v) => {\r\n                                if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                    // state 流转 临时\r\n                                    window['GlobalData'].stateProxy[v] = \"\";\r\n                                    window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                }\r\n                            });\r\n                        }\r\n\r\n                        if (signalingModel == 2) {\r\n                            if (user.role == 0) {\r\n                                if (user.signalingModel != signalingModel) {\r\n                                    Object.keys(prevState).forEach((v) => {\r\n                                        if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                            // state 流转 临时\r\n                                            window['GlobalData'].stateProxy[v] = \"\";\r\n                                            window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                        }\r\n                                    });\r\n                                }\r\n                            }\r\n                        }\r\n\r\n                        if (signalingModel == 3) {\r\n                            if (user.role == 0) {\r\n                                Object.keys(prevState).forEach((v) => {\r\n                                    if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                        // state 流转 临时\r\n                                        window['GlobalData'].stateProxy[v] = \"\";\r\n                                        window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                    }\r\n                                });\r\n                            }\r\n                        }\r\n                    }\r\n\r\n                    // 巡课 助教 同屏 老师\r\n                    if (role == 1 || role == 4) {\r\n                        if (user.role == 0) {\r\n                            Object.keys(prevState).forEach((v) => {\r\n                                if (!(globalThis._.isEqual(prevState[v], curState[v]))) {\r\n                                    // state 流转 临时\r\n                                    window['GlobalData'].stateProxy[v] = \"\";\r\n                                    window['GlobalData'].pubSub.emit(curState[v], v);\r\n                                }\r\n                            });\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            break;\r\n        }\r\n\r\n        case 'onUserChange': {\r\n            // 此回调 老师处理\r\n            if (window['GlobalData'].courseData.role != 0) {\r\n                return;\r\n            }\r\n\r\n            // 临时方案\r\n            // 老师端 人员变动 禁止 发送信令\r\n            // 老师退出重进：此处信息获取早于 页面状态初始化\r\n            if (data.data.type == 'create') {\r\n                window['GlobalData'].stateProxy[\"formal-panle-model02\"] = \"\";\r\n            }\r\n\r\n            if (data.data.type == 'join') {\r\n                let user = data.data.users[0];\r\n                if (user.role == 2) {\r\n                    window['GlobalData'].stateProxy[\"formal-panle-model02\"] = \"\";\r\n                }\r\n            }\r\n\r\n            if (data.data.type == 'leave') {\r\n                let user = data.data.users[0];\r\n                if (user.role == 2) {\r\n                    window['GlobalData'].stateProxy[\"formal-panle-model02\"] = \"\";\r\n                }\r\n            }\r\n\r\n            // 临时方案\r\n            // 定时同步 ：ipad 课件加载慢; 已获取进入房间的信息，但学生课件并未加载完成\r\n            if (data.data.type == 'join') {\r\n                let user = data.data.users[0];\r\n                this.countDown(user);\r\n            }\r\n\r\n            let canvas = this.node.parent.getChildByName('Canvas');\r\n            let panel = canvas.getChildByName('formal-panle-model02');\r\n            let panelJs: any = panel.getComponent(cc.Component);\r\n            panelJs.signalCallback(data.data);\r\n        }\r\n    }\r\n\r\n}"]}